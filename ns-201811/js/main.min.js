/*


 Nissan 美好在這禮 main.js

 @version 20181129

*/
var main=window.main||{};(function(){for(var a,b=function(){},c="assert clear count debug dir dirxml error exception group groupCollapsed groupEnd info log markTimeline profile profileEnd table time timeEnd timeline timelineEnd timeStamp trace warn".split(" "),d=c.length,f=window.console=window.console||{};d--;)a=c[d],f[a]||(f[a]=b)})();"addEventListener"in document&&document.addEventListener("DOMContentLoaded",function(){FastClick.attach(document.body)},!1);main.ua=navigator.userAgent.toLowerCase();
main.IE="Microsoft Internet Explorer"==navigator.appName&&null!=/MSIE ([0-9]{1,}[\.0-9]{0,})/.exec(navigator.userAgent)?parseFloat(RegExp.$1):99;9>=main.IE&&(document.documentElement.className+=" lte-ie9");8>=main.IE&&(document.documentElement.className+=" lte-ie8");
main.is_m=function(){var a=navigator.userAgent||navigator.vendor||window.opera;return window.mobi||/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,
4))}();document.documentElement.className+=main.is_m?" mobile":" no-mobile";main.hasTouchEvent=!!("ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch);document.documentElement.className+=main.hasTouchEvent?" touchevent":" no-touchevent";document.documentElement.className+="opacity"in document.body.style?"":" no-opacity";main.getPageY=function(){return window.pageYOffset||("clientHeight"in document.documentElement?document.documentElement:document.body).scrollTop};
main.getWinH=function(){return window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight||$(window).height()};main.getWinW=function(){return window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth||$(window).width()};main.getBodyH=function(){return Math.max(400,main.getWinH())};main.getHeaderH=function(){return main.isHeaderLayout("pc")?85:48};
main.getURLParam=function(a,b){var c=b?b.substr(b.lastIndexOf("?")):location.search;return(RegExp(a+"=([^&;]+?)(&|#|;|$)").exec(c)||[,null])[1]};main.emptyURLParam=function(a,b){var c=b||location.href;RegExp(a).test(c)&&/=/.test(c)&&"undefined"!=typeof history.replaceState&&(c=c.replace(a,a.split("=")[0]+"="),history.replaceState({},document.title,c))};
main.openShareWin=function(a,b){var c=parseInt((window.screen.availWidth-550)/2),d=parseInt(0.6*((window.screen.availHeight-420)/2));return window.open(a,b,"width=550,height=420,left="+c+",top="+d)};function getYoutubeVid(a){return(a=a.match(/.*(?:youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=)([^#\&\?]*).*/))&&11==a[1].length?a[1]:!1}var gatracking={debug:!1,pv:function(a){gatracking.debug&&console.log("GA pv=> ",a)},ev:function(a,b,c){gatracking.debug&&console.log("GA ev=> ",a,b,c)}};
$.fn.undraggable=function(){return this.each(function(){$(this).attr("draggable",!1).css("user-select","none")})};$(function(){$("img").undraggable()});
$.fn.blockTouchmovePropagation=function(a){return this.each(function(){this.wonb={};$(this).off("touchstart.wonb touchmove.wonb").on("touchstart.wonb",function(a){this.wonb.startY=a.originalEvent.touches?a.originalEvent.touches[0].screenY:a.originalEvent.screenY}).on("touchmove.wonb",function(b){if(void 0!=a&&$(a).find(b.target)[0])return!0;this.scrollHeight>this.offsetHeight?(this.wonb.currY=b.originalEvent.touches?b.originalEvent.touches[0].screenY:b.originalEvent.screenY,this.wonb.atTop=this.wonb.startY<=
this.wonb.currY&&0===this.scrollTop,this.wonb.atBottom=this.wonb.startY>=this.wonb.currY&&this.scrollHeight-this.scrollTop===$(this).innerHeight(),(this.wonb.atTop||this.wonb.atBottom)&&b.preventDefault()):b.preventDefault()})})};$.fn.getPageInview=function(){var a=[];main.getWinH();this.each(function(){a.push({el:$(this),value:Math.abs($(this).offset().top-main.getPageY())})});a.sort(function(a,c){return a.value<c.value?-1:a.value>c.value?1:0});return a[0].el};
main.scrollTo=function(a){function b(a,b){if("#"==a)$.scrollTo(0,{axis:"y",duration:366,easing:"easeInOutCirc"});else{var f=$(a);if(f[0]){var g=Math.abs(f.offset().top-main.getPageY());b=$.extend({offset:-1*main.getHeaderH(),duration:Math.round(Math.max(500,0.3*g))},b||{});$.scrollTo(f,{offset:b.offset,axis:"y",duration:b.duration,easing:"easeInOutQuad"})}}}$(function(){$(document).on("click","[data-scrollTo]",function(a){b($(this).attr("href"));a.preventDefault()})});return b}();
main.isHeaderLayout=function(a){function b(){960>=main.getWinW()&&!c("mb")&&($("html").removeClass("header-pc").addClass("header-mb"),$(window).trigger("headerLayout",["mb"]));960<main.getWinW()&&c("mb")&&($("html").removeClass("header-mb").addClass("header-pc"),$(window).trigger("headerLayout",["pc"]))}function c(a){return $("html").hasClass("header-"+a)}$(function(){$(window).on("resize orientationchange load",b);b();setTimeout(b,31)});return c}();
main.updateHeaderState=function(){function a(){if($("#header")[0]){var a=main.getHeaderH(),c=main.getPageY();$("html").toggleClass("header-fixed",c>=a);$("html").toggleClass("leave-top",c>=0.5*main.getWinH())}}$(function(){$(window).on("scroll resize orientationchange load touchmove",a);a();setTimeout(a,31)});return a}();
main.updateBodyH=function(){function a(){var a=main.getBodyH();$("#wrap").css("min-height",a)}$(function(){$(window).on("resize.updateBodyH orientationchange load",a);$("body").imagesLoaded(a);setTimeout(a,1111);a()});return a}();main.resizeWith=function(a){function b(a){$.each(c,function(a,b){b()})}var c=[];$(function(){$(window).on("resize orientationchange",b);b();setTimeout(b,11);setTimeout(b,1111)});return function(a){$.isFunction(a)&&c.push(a)}}();
main.scrollWith=function(a){function b(a){$.each(c,function(a,b){b()})}var c=[];$(function(){$(window).on("scroll resize orientationchange touchmove touchstart",b);b();setTimeout(b,11);setTimeout(b,1111)});return function(a){$.isFunction(a)&&c.push(a)}}();$.fn.mid=function(a){var b=main.getPageY(),c=main.getWinH(),d=this.height(),b=2*((this.offset().top+d-b)/(c+d))*a-a,b=0.001*Math.round(1E3*b);return b=Math.max(-1*a,Math.min(a,b))};
$.fn.isInView=function(){if(!$(this)[0])return!1;var a=main.getPageY(),b=main.getWinH(),c=$(this),d=c.offset().top,c=c.height();return a>d-b&&a<d+c};
main.popout=function(){function a(e){function h(){$("html").addClass("popout-open");d.fadeTo(0,0);$("#popout").show();d.delay(100).fadeTo(main.is_m?0:200,1,function(){$("#popout").scrollTop(0)});d.add('<img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">').imagesLoaded(b);setTimeout(b,100);$.isFunction(e.afterOpen)&&e.afterOpen()}e=e||{};if(void 0!=e.type&&void 0!=e.target)if(main.popout.isOpen())c({duration:0,afterClose:function(){a(e)}});else switch($("#popout").removeClass().addClass("popout "+
(e.classes||"")),$("#popout").off("click.closepopout").on("click.closepopout",function(a){!0==e.clickClose&&($(e.target).is(a.target)||0!=$(e.target).find(a.target).length||c())}),f=e.afterClose,g=main.getPageY(),$("#wrap").css("margin-top",-g),e.type){case "inline":if(!$(e.target)[0])return c(),!0;$("#popout").addClass("type-inline");$(e.target).after('<div id="'+e.target.replace("#","")+'-placeholder"></div>');$(e.target).css("display","block").appendTo(d);h();break;case "ajax":$("#popout").addClass("type-ajax");
$("#popoutLoading").show();d.load(e.target+" #popout-ajaxContent",function(a,b,d){"error"==b?c():h();$("#popoutLoading").hide()});break;case "iframe":$("#popout").addClass("type-iframe"),$("#popoutLoading").show(),$('<iframe class="popout-iframe" vspace="0" hspace="0" src="'+e.target+'" frameborder="0" scrolling="auto" allowtransparency="true" style="width:100%;height:100%"></iframe>').appendTo(d).load(function(){$("#popoutLoading").hide()}),h()}}function b(){var a=Math.max(main.is_m?0:50,0.5*(main.getWinH()-
d.height()));d.css("padding-top",a).css("padding-bottom",a)}function c(a){a=a||{};$("#popout").fadeOut(void 0==a.duration?0:a.duration,function(){if($("#popout").hasClass("type-inline")){var b=d.children();b.css("display","none");b.insertBefore("#"+b[0].id+"-placeholder");$("#"+b[0].id+"-placeholder").remove()}d.empty();$("html").removeClass("popout-open");$("#wrap").css("margin-top","");$("html, body").scrollTop(g);$.isFunction(f)&&f();f=null;$.isFunction(a.afterClose)&&a.afterClose()});$("#popoutLoading").hide()}
var d,f,g;$(function(){$('<div id="popoutLoading"></div><div id="popout" class="popout"><div class="popout-overlay"></div><div class="popout-inner"><div class="popout-content"></div></div></div>').appendTo("body");d=$("#popout .popout-content");$(document).on("click","[data-closepopout]",function(){c()});$(document).on("keydown.closepopout",function(a){27==a.keyCode&&c()});$("#popout").blockTouchmovePropagation()});return{open:a,close:c,position:b,isOpen:function(){return $("html").hasClass("popout-open")}}}();
main.nav=function(){function a(){c()||(d.removeClass("out").addClass("in"),f.removeClass("out").addClass("in"),$("html").addClass("nav-open"))}function b(){c()&&(d.removeClass("in").addClass("out"),f.removeClass("in").addClass("out"),$("html").removeClass("nav-open"),setTimeout(function(){d.removeClass("out");f.removeClass("out")},400))}function c(){return $("html").hasClass("nav-open")}var d,f,g;$(function(){d=$("#navMenu");d[0]&&(f=$("#navOverlay"),g=$("#navToggle"),$(".btn",d).not('[href^="ja"], [href="#"]').on("click",
function(){b()}),$(window).on("headerLayout",function(a,c){$(".mainitem",d).removeClass("active");"pc"==c&&b()}),d.blockTouchmovePropagation(),f.blockTouchmovePropagation(),f.on("click",function(){b()}),g.on("click",function(){c()?b():a()}),$(".btn[data-submenu]",d).on("click",function(a){var b=$(this);b.toggleClass("on");b.next(".submenu").slideToggle(200,"easeOutQuart");main.isHeaderLayout("pc")&&b.hasClass("on")&&(a.stopPropagation(),$(document).off("click.sm").one("click.sm",function(){b.trigger("click")}))}))});
return{toggle:g,open:a,close:b,isOpen:c}}();main.initBacktop=function(){main.scrollWith(function(){var a=main.getPageY()+main.getWinH(),b=$("#footer").offset().top;$("#backtop").toggleClass("fixed-bottom",a>=b)})};main.sectCtrl={};main.sectCtrl.id=null;main.sectCtrl.menu={top:"top",offer:"offer",gift:"gift",drive:"drive"};main.sectCtrl.visited={top:0,offer:0,gift:0,drive:0};
main.sectCtrl.init=function(){$(window).hashchange(main.sectCtrl.onHashChange);main.sectCtrl.onHashChange();$(window).on("scroll touchend touchmove orientationchange resize",main.sectCtrl.onScrollPage);setTimeout(main.sectCtrl.onScrollPage,111)};main.sectCtrl.onHashChange=function(a){a=location.hash;RegExp("^#/("+$.map(main.sectCtrl.menu,function(a,c){return[a]}).join("|")+")$").test(a)?main.sectCtrl.gotoPage(main.sectCtrl.menu[a.replace("#/","")]):""!=a&&"#/"!=a&&"#"!=a||main.sectCtrl.gotoPage("top")};
main.sectCtrl.setHash=function(a){location.hash="#/"+main.sectCtrl.menu[a]};main.sectCtrl.gotoPage=function(a,b){if(main.sectCtrl.id!=a||b)main.isLocal&&console.log("gotoPage id=>",a),main.normalizeScrollTo(a)};main.sectCtrl.onScrollPage=function(){var a=$("#"+$.map(main.sectCtrl.menu,function(a,c){return[a]}).join(",#")).getPageInview().attr("id");a!=main.sectCtrl.id&&main.sectCtrl.setActivePage(a)};
main.sectCtrl.setActivePage=function(a){main.sectCtrl.id=a;var b=$('#navMenu .list .btn[href="#/'+main.sectCtrl.menu[a]+'"]');b.addClass("on");$("#navMenu .list .btn").not(b).removeClass("on");main.sectCtrl.setHash(a);main.sectCtrl.readPage(a);0==main.sectCtrl.visited[a]&&(main.sectCtrl.visited[a]=1)};
main.sectCtrl.readPage=function(a){main.sectCtrl.id==a&&(window.readPageId&&clearTimeout(window.readPageId),window.readPageId=setTimeout(function(){var b=$('#navMenu .list .btn[href="#/'+main.sectCtrl.menu[a]+'"]');(b=b.find("img").attr("alt")||b.find("b").text())&&gatracking.pv(b)},1800),"top"!=a||$("html").hasClass("loading"))};main.isLocal=/file:/.test(location.protocol)||/wowface/.test(location.host);
main.init=function(){main.initBacktop();main.sectCtrl.init();main.loadSite();main.addBtnListeners();main.initAnimations()};main.loadSite=function(){function a(){clearTimeout(b);c?setTimeout(main.startSite,d):b=setTimeout(a,31)}var b,c=!1,d=66;$("body").imagesLoaded(function(){c=!0});a();setTimeout(function(){c=!0},15E3)};main.startSite=function(){$("html").hasClass("loading")&&($("html").removeClass("loading"),main.isLocal&&console.log("main.startSite"),$("#loader").remove(),main.topAnim.play(),$(document).trigger("startSite"))};
main.normalizeScrollTo=function(a){if(main.is_m)switch(a){case "offer":main.scrollTo("#"+a);break;default:main.scrollTo("#"+a)}else switch(a){case "offer":case "gift":case "drive":main.scrollTo("#"+a,{offset:0});break;default:main.scrollTo("#"+a)}};
main.addBtnListeners=function(){$(document).on("click",'#navMenu [href^="#/"]',function(a){var b=$(this).attr("href").replace("#/","");main.normalizeScrollTo(b);a.preventDefault();gatracking.ev("[主選單]"+$(this).find("b").text())});$(document).on("click",".btn-fb, .btn-share",function(a){var b=$('[property="og:url"]').attr("content");main.openShareWin("https://www.facebook.com/sharer/sharer.php?u="+encodeURIComponent(b),"Share");gatracking.ev("[按鈕]FB分享");a.preventDefault()});$(document).on("click",
"#rules .btn-toggle",function(a){$("#rules .list li.shy").removeClass("shy");$(this).hide()});$(document).on("click","[data-youtube]",function(a){var b=getYoutubeVid($(this).attr("href"));main.playVideo(b);a.preventDefault()});$(document).on("click","[data-gift]",function(a){var b=$(this).attr("data-gift");main.openGift(b);a.preventDefault()});$(document).on("click","#ph .menu .btn",function(a){var b=$(this).attr("href");$(this).addClass("on").siblings().removeClass("on");$(b).fadeIn(555).siblings(".page").hide();
a.preventDefault()})};main.openGift=function(a){main.popout.open({target:"#"+a,type:"inline",classes:"fullpage popout-"+a,afterOpen:function(){},afterClose:function(){}})};main.setTopHeight=function(){main.is_m&&(main.getWinH(),main.getHeaderH())};main.topAnim=new TimelineMax({paused:!0});
main.initAnimations=function(){main.is_m?main.topAnim.add([TweenMax.to("#top .whiteout",1,{autoAlpha:0,ease:Power1.easeInOut})],"+=.3").add([TweenMax.from("#top .descr",0.5,{delay:0,y:30,autoAlpha:0,ease:Power2.easeOut}),TweenMax.from("#top .video",0.5,{delay:0.2,y:30,autoAlpha:0,ease:Power2.easeOut})],"-=.5").call(function(){TweenMax.to("#top .scroll",0.6,{alpha:0,ease:Power1.easeInOut,yoyo:!0,repeat:-1,repeatDelay:0.5})}):(main.topAnim.add([TweenMax.to("#top .whiteout",1,{delay:0,autoAlpha:0,ease:Power1.easeInOut}),
TweenMax.from("#top .kv",1.2,{scale:1.5,x:500,y:-50,alpha:0.2,transformOrigin:"10% 15%",ease:Cubic.easeInOut}),TweenMax.from("#top .title",0.7,{delay:0.5,x:-70,autoAlpha:0,ease:Power2.easeOut}),TweenMax.from("#top .descr",0.7,{delay:0.7,x:-70,autoAlpha:0,ease:Power2.easeOut}),TweenMax.from("#top .video",0.7,{delay:0.85,x:-70,autoAlpha:0,ease:Power2.easeOut}),TweenMax.staggerFrom(["#top .s","#top .k","#top .x","#top .ph","#top .zw"],0.75,{delay:1,scale:0.4,transformOrigin:"50% 100%",ease:Elastic.easeOut,
onStart:function(){$(this.target).css("visibility","visible")}},0.12)],"+=.3"),main.scrollWith(function(){$("#gift1 .descr:not(.playdone)").isInView()&&($("#gift1 .descr").addClass("playdone"),TweenMax.staggerFrom("#gift1 .text > *",0.6,{delay:0.5,y:30,autoAlpha:0,ease:Power2.easeOut},0.2));$("#gift2 .descr:not(.playdone)").isInView()&&($("#gift2 .descr").addClass("playdone"),TweenMax.staggerFrom("#gift2 .text > *",0.6,{delay:0.3,y:30,autoAlpha:0,ease:Power2.easeOut},0.2))}),main.scrollWith(function(){$("#offer .talent:not(.playdone)").isInView()&&
($("#offer .talent").addClass("playdone"),(new TimelineMax).add([TweenMax.staggerFrom("#offer .title, #offer .item.n1, #offer .item.n2",0.5,{x:-100,autoAlpha:0,ease:Power2.easeOut,clearProps:"opacity,transform"},0.2),TweenMax.staggerFrom("#offer .item.n3, #offer .item.n4",0.5,{delay:0.8,x:100,autoAlpha:0,ease:Power2.easeOut,clearProps:"opacity,transform"},0.2)],"+=.5").from("#offer .bubble",0.6,{scale:0,transformOrigin:"100% 100%",onStart:function(){$(this.target).css("visibility","visible")},ease:Back.easeOut},
"-=.3"));var a=$("#offer .talent").mid(1);TweenMax.to("#offer .talent",0.6,{y:-80*a,ease:Power1.easeOut})}),main.scrollWith(function(){$("#drive .cars:not(.playdone)").isInView()&&($("#drive .cars").addClass("playdone"),(new TimelineMax).add([TweenMax.from("#drive .k",0.4,{x:-200,ease:Cubic.easeOut,onStart:function(){$(this.target).css("visibility","visible")}}),TweenMax.staggerFrom(["#drive .x","#drive .s","#drive .t"],0.5,{scale:0,x:200,y:20,ease:Power2.easeOut,onStart:function(){$(this.target).css("visibility",
"visible")}},0.1)],"+=.5"))}))};main.playVideo=function(a){main.popout.open({target:"#playerBox",type:"inline",afterOpen:function(){var b="https://www.youtube.com/embed/"+a+"?rel=0&showinfo=0&autoplay=1&controls=1";$("#playerBox .player").append('<iframe width="1072" height="578" src="'+b+'" frameborder="0" allowfullscreen></iframe>')},afterClose:function(){$("#playerBox .player iframe").attr("src","about:blank").remove()}})};$(main.init);
